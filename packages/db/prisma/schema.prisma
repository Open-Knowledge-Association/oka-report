// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// Registered Wikipedia editors to track
/// These are OKA members, grantees, or other editors whose contributions we monitor
model Editor {
  id String @id @default(cuid())

  /// Wikipedia username (case-sensitive, must match exactly)
  /// Format: Underscores for spaces (e.g., "Jimbo_Wales" not "Jimbo Wales")
  /// Example: "Jimbo_Wales", "Example_User_123"
  username String @unique

  /// Wikimedia global user ID (optional, for future cross-wiki tracking)
  /// Example: 12345678
  wikimediaUserId Int?

  /// Whether this editor is actively being tracked
  /// Set to false to pause syncing without deleting historical data
  /// Example: true (active), false (paused)
  isActive Boolean @default(true)

  /// Source of this editor record for audit trail
  /// Values: "manual" (added via UI), "csv_import" (bulk import), 
  ///         "outreach_dashboard" (future), "wiki_category" (future)
  /// Example: "manual"
  source String @default("manual")

  /// External ID from source system (for sync deduplication)
  /// Example: Outreach Dashboard participant ID "12345"
  externalId String?

  contributions   Contribution[]
  commonsUploads  CommonsUpload[]
  createdArticles Article[]       @relation("CreatedArticles")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("editors")
}

/// Wikipedia articles created or modified by tracked editors
model Article {
  id String @id @default(cuid())

  /// MediaWiki page ID (unique within each wiki project)
  /// Example: 12345678
  pageId Int

  /// Article title as it appears in the URL (with underscores)
  /// Format: "Article_Title" not "Article Title"
  /// Example: "Borobudur_Temple", "Komodo_dragon"
  title String

  /// Wikipedia language/project code
  /// Format: "{lang}.wikipedia.org" 
  /// Example: "en.wikipedia.org", "id.wikipedia.org", "commons.wikimedia.org"
  wikiProject String

  /// Reference to the tracked editor who created this article (if any)
  /// Null if article was created by a non-tracked editor
  createdByEditor   Editor?   @relation("CreatedArticles", fields: [createdByEditorId], references: [id])
  createdByEditorId String?

  /// When this article was first created on Wikipedia
  /// Fetched from MediaWiki API (first revision timestamp)
  /// Example: "2024-03-15T10:30:00Z"
  articleCreatedAt DateTime?

  contributions Contribution[]
  pageviews     Pageview[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pageId, wikiProject])
  @@map("articles")
}

/// Individual edit/contribution made by a tracked editor
model Contribution {
  id String @id @default(cuid())

  editor   Editor @relation(fields: [editorId], references: [id])
  editorId String

  article   Article @relation(fields: [articleId], references: [id])
  articleId String

  /// MediaWiki revision ID (unique identifier for this edit)
  /// Example: 1234567890
  revisionId Int

  /// Parent revision ID (the revision this edit was based on)
  /// Null for the first revision (article creation)
  /// Example: 1234567889
  parentId Int?

  /// Net bytes changed in this edit (positive = added, negative = removed)
  /// Example: 1500 (added 1.5KB), -200 (removed 200 bytes)
  bytesChanged Int

  /// Estimated words added (calculated as bytesChanged / 6)
  /// Based on Wikimedia's standard estimation methodology
  /// Example: 250 (approximately 250 words added)
  wordsAdded Int @default(0)

  /// Whether this edit created the article (first revision)
  /// True only for the initial creation edit
  /// Example: true (article creation), false (subsequent edit)
  isCreation Boolean @default(false)

  /// Timestamp of when this edit was made on Wikipedia
  /// Example: "2026-01-15T10:30:00Z"
  editTimestamp DateTime

  createdAt DateTime @default(now())

  @@unique([revisionId, articleId])
  @@index([editorId])
  @@index([articleId])
  @@index([editTimestamp])
  @@map("contributions")
}

/// Daily pageview statistics for tracked articles
/// Only tracks articles CREATED by tracked editors (per PRD requirement)
model Pageview {
  id String @id @default(cuid())

  article   Article @relation(fields: [articleId], references: [id])
  articleId String

  /// Date for this pageview count (daily granularity)
  /// Format: Date only, no time component
  /// Example: "2026-01-15"
  date DateTime @db.Date

  /// Number of pageviews on this date
  /// Source: Wikimedia Pageviews API (user traffic only, excludes bots)
  /// Example: 1523
  views Int

  createdAt DateTime @default(now())

  @@unique([articleId, date])
  @@index([date])
  @@map("pageviews")
}

/// Wikimedia Commons file uploads by tracked editors
model CommonsUpload {
  id String @id @default(cuid())

  editor   Editor @relation(fields: [editorId], references: [id])
  editorId String

  /// Filename on Commons (without "File:" namespace prefix)
  /// Format: Exact filename with extension
  /// Example: "Borobudur_sunrise_2024.jpg"
  fileName String

  /// Full URL to the file on Commons
  /// Example: "https://upload.wikimedia.org/wikipedia/commons/a/ab/Borobudur_sunrise_2024.jpg"
  fileUrl String

  /// File size in bytes
  /// Example: 2500000 (2.5 MB)
  fileSize Int?

  /// MIME type of the uploaded file
  /// Example: "image/jpeg", "image/png", "video/webm", "application/pdf"
  mimeType String?

  /// When the file was uploaded to Commons
  /// Example: "2026-01-15T10:30:00Z"
  uploadedAt DateTime

  createdAt DateTime @default(now())

  @@unique([fileName])
  @@index([editorId])
  @@map("commons_uploads")
}

/// Background sync job tracking for monitoring and debugging
model SyncJob {
  id String @id @default(cuid())

  /// Type of sync operation
  /// Values: "full" (all data), "contributions", "pageviews", "commons", "editors"
  /// Example: "full"
  jobType String

  /// Current status of the job
  /// Values: "pending", "running", "completed", "failed"
  /// Example: "running"
  status String

  /// When the job started execution
  /// Null if still pending
  startedAt DateTime?

  /// When the job finished (success or failure)
  completedAt DateTime?

  /// Error message if job failed
  /// Example: "Rate limited by Wikimedia API after 1000 requests"
  error String?

  /// Job statistics and metadata as JSON
  /// Example: {"editorsProcessed": 50, "contributionsSynced": 1234, "errors": 2}
  metadata Json?

  createdAt DateTime @default(now())

  @@index([status])
  @@index([jobType])
  @@map("sync_jobs")
}

/// Application users for admin access
/// Dashboard is publicly viewable; auth required for admin functions
model User {
  id String @id @default(cuid())

  /// User email (used for login)
  /// Example: "admin@oka.org"
  email String @unique

  /// User's display name
  /// Example: "Admin User"
  name String?

  /// Hashed password (bcrypt)
  /// Never store plain text passwords
  password String

  /// User role for access control
  /// Values: "admin" (full access), "viewer" (read-only)
  /// Example: "admin"
  role String @default("viewer")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}
